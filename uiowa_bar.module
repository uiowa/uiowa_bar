<?php

/**
 * @file
 *
 * Adds the University of Iowa branding bar to each page
 */

/**
 * Implements hook_init().
 */
function uiowa_bar_init() {
  if (arg(0) != 'admin') {
    /* Include CSS Assets */
    drupal_add_css(drupal_get_path('module', 'uiowa_bar') . '/css/ui-global-bar.css');

    /* Include Javascript Assets */
    drupal_add_js(drupal_get_path('module', 'uiowa_bar') . '/js/uniform/jquery.uniform.min.js');
    drupal_add_js(drupal_get_path('module', 'uiowa_bar') . '/js/ui-header.js');
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function uiowa_bar_preprocess_html(&$vars) {
  // Add a body class for the active theme name.
  $vars['classes_array'][] = variable_get('uiowa_bar_color_palette');
  $vars['classes_array'][] = variable_get('uiowa_bar_link_style') . '-style';
}

/**
* Implements hook_permission().
*/
function uiowa_bar_permission() {
  return array(
    'administer uiowa bar' => array(
      'title' => t('Administer UIowa branding bar'),
      'description' => t('Perform administration tasks for the UIowa branding bar.'),
    ),
  );
}

/**
* Implements hook_menu().
*/
function uiowa_bar_menu() {
  $items = array();

  $items['admin/config/user-interface/uiowa-bar'] = array(
    'title' => 'University of Iowa branding bar',
    'description' => 'Configuration for the University of Iowa branding bar',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('uiowa_bar_config_form'),
    'access arguments' => array('administer uiowa bar'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/uiowa_bar.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_form_system_theme_settings_alter().
 */
function uiowa_bar_form_system_theme_settings_alter(&$form, &$form_state)  {
  // Custom UI Branded Bar Styles
  $form['at-settings']['ui_branding'] = array(
    '#type' => 'fieldset',
    '#title' => t('UIowa branding bar'),
    '#description' => t('<p>University of Iowa branding bar customization.</p>'),
  );

  $form['at-settings']['ui_branding']['content'] = array(
    '#type' => 'markup',
    '#markup' => '<p>Many customization options are available for the University of Iowa branding bar, including color palette and how the bar functions.</p>
    <p><a href="' . $GLOBALS['base_url'] . '/admin/config/user-interface/uiowa-bar">Customize the University of Iowa branding bar</a>.</p>'
  );
}

/**
 * Implements hook_theme().
 */
function uiowa_bar_theme(){
  return array(
    'uiowa_bar' => array(
        'path'      => drupal_get_path('module', 'uiowa_bar').'/theme',
        'template'  => 'uiowa-bar',
    ),
    'uiowa_bar_link_list' => array(
      'render element' => 'links',
    ),
  );
}

/**
 * Add University of Iowa branding bar markup to page
 */
function uiowa_bar_page_build(&$page) {
  global $theme_key;
  if (variable_get('theme_default','none') === $theme_key) {
    $page['page_top']['uiowa_bar'] = array(
      '#markup' => theme('uiowa_bar'),
      '#weight' => 25,
    );
  }
}

/**
 * Theme function to build a list of action links for the University of Iowa
 * branding bar.
 */
function theme_uiowa_bar_link_list($variables = array()) {
  $type = variable_get('uiowa_bar_link_style');
  $links = array();
  foreach ($variables['links']['#children'] as $link) {
    $links[] = l($link['label'], $link['url'], array(
      'attributes' => array(
        'class' => array($type, $link['class']),
        'title' => $link['title'])
      )
    );
  }
  return theme('item_list', array('items' => $links));
}

/**
 * Base URL without the protocol - needed for the Google Search Appliance.
 */
function uiowa_bar_base_url_no_protocol() {
  $url = preg_replace('/^https?:\/\//i', '', $GLOBALS['base_url']);
  return $url;
}

/**
 * Build out the University of Iowa branding bar.
 */
function build_uiowa_bar() {
  $uiowa_bar = array();
  $uiowa_bar['ui-global-bar'] = array(
    '#attributes' => array('id' => array('ui-global-bar')),
    '#type' => 'container',
  );
  $uiowa_bar['ui-global-bar']['ui-logo'] = array(
    '#attributes' => array('id' => array('ui-logo')),
    '#type' => 'container',
  );
  $uiowa_bar['ui-global-bar']['ui-logo']['link'] = array(
    '#type' => 'link',
    '#title' => t('The University of Iowa'),
    '#href' => 'http://www.uiowa.edu',
  );
  $uiowa_bar['ui-global-bar']['ui-global-bar-nav'] = array(
    '#attributes' => array('id' => array('ui-global-bar-nav')),
    '#type' => 'container',
  );
  $uiowa_bar['ui-global-bar']['ui-global-bar-nav']['ui-global-links'] = array(
    '#attributes' => array('id' => array('ui-global-links')),
    '#type' => 'container',
  );
  $uiowa_bar['ui-global-bar']['ui-global-bar-nav']['ui-global-links']['links'] = array(
    '#theme' => 'uiowa_bar_link_list',
    '#children' => array(
      0 => array(
        'label' => t('Phonebook'),
        'url' => 'http://www.uiowa.edu/homepage/directories/',
        'class' => 'phonebook',
        'title' => 'Phonebook'
      ),
      1 => array(
        'label' => t('Maps'),
        'url' => 'http://www.uiowa.edu/homepage/hub/tours.html',
        'class' => 'maps',
        'title' => 'Maps'
      ),
      2 => array(
        'label' => t('A-Z'),
        'url' => 'http://www.uiowa.edu/homepage/search/index.html',
        'class' => 'a-z',
        'title' => 'A-Z'
      ),
      3 => array(
        'label' => t('Search'),
        'url' => '#',
        'class' => 'search',
        'title' => 'Search'
      )
    )
  );
  $uiowa_bar['ui-global-bar']['ui-global-bar-nav']['gsa-search'] = array(
    '#attributes' => array('id' => array('gsa-search')),
    '#type' => 'container',
  );
  $uiowa_bar['ui-global-bar']['ui-global-bar-nav']['gsa-search']['search-form'] = drupal_get_form('uiowa_bar_search_form');
  return $uiowa_bar;
}

/**
 * Build out search form for the GSA.
 */
function uiowa_bar_search_form($form, &$form_state) {
  $form = array();
  $form['#action'] = 'http://search.uiowa.edu/search';
  $form['#method'] = 'get';
  $form['fieldset'] = array (
    '#type' => 'fieldset'
  );
  $form['fieldset']['search-terms'] = array (
    '#prefix' => '<legend class="element-hidden">Search</legend><div id="search-box">',
    '#type' => 'textfield',
    '#title' => t('Search Terms'),
    '#title_display' => 'invisible',
    '#attributes' => array(
      'placeholder' => 'Start Searching ...'
    ),
    '#name' => 'q',
    '#maxlength' => '256',
    '#size' => '15'
  );
  $form['fieldset']['sitesearch'] = array (
    '#prefix' => '<div id="sitesearch-container">',
    '#type' => 'select',
    '#title' => t('for'),
    '#name' => 'sitesearch',
    '#options' => array(
      uiowa_bar_base_url_no_protocol() => 'This Site',
      'www.uiowa.edu' => 'All Sites'
    )
  );
  $form['fieldset']['submit-search'] = array (
    '#type' => 'submit',
    '#value' => t('Search'),
    '#name' => 'btnG',
    '#suffix' => '</div>'
  );
  $form['fieldset']['hidden-site'] = array (
    '#type' => 'hidden',
    '#value' => t('default_collection'),
    '#name' => 'site',
  );
  $form['fieldset']['hidden-client'] = array (
    '#type' => 'hidden',
    '#value' => t('default_frontend'),
    '#name' => 'client',
  );
  $form['fieldset']['hidden-output'] = array (
    '#type' => 'hidden',
    '#value' => t('xml_no_dtd'),
    '#name' => 'output',
  );
  $form['fieldset']['hidden-proxystylesheet'] = array (
    '#type' => 'hidden',
    '#value' => t('default_frontend'),
    '#name' => 'proxystylesheet',
    '#suffix' => '</div>'
  );
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter.
 */
function uiowa_bar_preprocess_uiowa_bar(&$variables) {
  $variables['uiowa_bar'] = build_uiowa_bar();
}
