<?php

/**
 * @file
 *
 * Adds the University of Iowa Branding Bar to your theme
 */

/**
 * Implements hook_init().
 */
function uiowa_bar_init() {
  if (arg(0) != 'admin') {
    /* Include CSS Assets */
    drupal_add_css(drupal_get_path('module', 'uiowa_bar') . '/css/ui-global-bar.css');

    /* Include Javascript Assets */
    drupal_add_js(drupal_get_path('module', 'uiowa_bar') . '/js/uniform/jquery.uniform.min.js');
    drupal_add_js(drupal_get_path('module', 'uiowa_bar') . '/js/ui-header.js');
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function uiowa_bar_preprocess_html(&$vars) {
  global $theme_key;

  // Add a body class for the active theme name.
  $vars['classes_array'][] = theme_get_setting('ui_globalbar');
  $vars['classes_array'][] = theme_get_setting('ui_globalbar_link_style');
}

/**
 * Implements hook_form_system_theme_settings_alter().
 */
function uiowa_bar_form_system_theme_settings_alter(&$form, &$form_state)  {
  // Custom UI Branded Bar Styles
  $form['at-settings']['ui_branding'] = array(
    '#type' => 'fieldset',
    '#title' => t('UI Branding'),
    '#description' => t('<h3>UI Branding Bar</h3><p>This setting allows you to customize the top University of Iowa branded bar.</p>'),
  );

  $form['at-settings']['ui_branding']['ui_globalbar'] = array(
    '#type' => 'select',
    '#title' => t('Color Palette'),
    '#default_value' => theme_get_setting('ui_globalbar', variable_get('theme_default','none')),
    '#description' => t('Choose the color palette of the UI Branded Bar'),
    '#options' => array(
      'skin-a' => t('Light Theme'),
      'skin-b' => t('Dark Theme'),
    ),
  );

  $form['at-settings']['ui_branding']['ui_globalbar_link_style'] = array(
    '#type' => 'select',
    '#title' => t('Link Style'),
    '#default_value' => theme_get_setting('ui_globalbar_link_style', variable_get('theme_default','none')),
    '#description' => t('Choose the link style for the UI Branded Bar action links'),
    '#options' => array(
      'uiowa-icon' => t('Icon-based'),
      'uiowa-text' => t('Text-based'),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function uiowa_bar_theme(){
  return array(
    'uiowa_bar' => array(
        'path'      => drupal_get_path('module', 'uiowa_bar').'/theme',
        'template'  => 'uiowa-bar',
    ),
    'uiowa_bar_link_list' => array(
      'render element' => 'links',
    ),
  );
}

/**
 * Add uiowa_bar markup to page
 */
function uiowa_bar_page_build(&$page) {
  global $theme_key;
  if (variable_get('theme_default','none') === $theme_key) {
    $page['page_top']['uiowa_bar'] = array(
      '#markup' => theme('uiowa_bar'),
      '#weight' => 25,
    );
  }
}

/**
 * Displays a list of links.
 */
function theme_uiowa_bar_link_list($variables = array()) {
  $type = theme_get_setting('ui_globalbar_link_style');
  $links = array();
  foreach ($variables['links']['#children'] as $link) {
    $links[] = l($link['label'], $link['url'], array('attributes' => array('class' => array($type, $link['class']))));
  }
  return theme('item_list', array('items' => $links));
}

/**
 * Base URL without the protocol - needed for the Google Search Appliance.
 */
function base_url_no_protocol() {
  $url = preg_replace('/^https?:\/\//i', '', $GLOBALS['base_url']);
  return $url;
}

/**
 * Build out the UIowa Bar.
 */
function build_uiowa_bar() {
  $uiowa_bar = array(
    'ui-global-bar' => array( // Create <div id="ui-global-bar">
      '#attributes' => array('id' => array('ui-global-bar')),
      '#type' => 'container',
      'ui-logo' => array( // Create <div id="ui-logo">
        '#attributes' => array('id' => array('ui-logo')),
        '#type' => 'container',
        'link' => array( // Create <a href="http://www.uiowa.edu">The University of Iowa</a></div>
          '#type' => 'link',
          '#title' => t('The University of Iowa'),
          '#href' => 'http://www.uiowa.edu',
        )
      ),
      'ui-global-bar-nav' => array(
        '#attributes' => array('id' => array('ui-global-bar-nav')),
        '#type' => 'container',
        'ui-global-links' => array( // Create <div id="ui-global-links">
          '#attributes' => array('id' => array('ui-global-links')),
          '#type' => 'container',
          'links' => array(
            '#theme' => 'uiowa_bar_link_list',
            '#children' => array(
              0 => array(
                'label' => t('Phonebook'),
                'url' => 'http://www.uiowa.edu/homepage/directories/',
                'class' => 'phonebook'
              ),
              1 => array(
                'label' => t('Maps'),
                'url' => 'http://www.uiowa.edu/homepage/hub/tours.html',
                'class' => 'maps'
              ),
              2 => array(
                'label' => t('A-Z'),
                'url' => 'http://www.uiowa.edu/homepage/search/index.html',
                'class' => 'a-z'
              ),
              3 => array(
                'label' => t('Search'),
                'url' => '#',
                'class' => 'search'
              )
            )
          )
        ),
        'gsa-search' => array(
          '#attributes' => array('id' => array('gsa-search')),
          '#type' => 'container',
          'search-form' => drupal_get_form('uiowa_bar_search_form'),
        )
      )
    )
  );

return $uiowa_bar;

}

/**
 * Build out search form for the GSA.
 */
function uiowa_bar_search_form($form, &$form_state) {
  $form = array();
  $form['#action'] = 'http://search.uiowa.edu/search';
  $form['#method'] = 'get';
  $form['fieldset'] = array (
    '#type' => 'fieldset'
  );
  $form['fieldset']['search-terms'] = array (
    '#prefix' => '<legend class="element-hidden">Search</legend><div id="search-box">',
    '#type' => 'textfield',
    '#title' => t('Search Terms'),
    '#title_display' => 'invisible',
    '#attributes' => array(
      'placeholder' => 'Start Searching ...'
    ),
    '#name' => 'q',
    '#maxlength' => '256',
    '#size' => '15'
  );
  $form['fieldset']['sitesearch'] = array (
    '#prefix' => '<div id="sitesearch-container">',
    '#type' => 'select',
    '#title' => t('for'),
    '#name' => 'sitesearch',
    '#options' => array(
      base_url_no_protocol() => 'This Site',
      'www.uiowa.edu' => 'All Sites'
    )
  );
  $form['fieldset']['submit-search'] = array (
    '#type' => 'submit',
    '#value' => t('Search'),
    '#name' => 'btnG',
    '#suffix' => '</div>'
  );
  $form['fieldset']['hidden-site'] = array (
    '#type' => 'hidden',
    '#value' => t('default_collection'),
    '#name' => 'site',
  );
  $form['fieldset']['hidden-client'] = array (
    '#type' => 'hidden',
    '#value' => t('default_frontend'),
    '#name' => 'client',
  );
  $form['fieldset']['hidden-output'] = array (
    '#type' => 'hidden',
    '#value' => t('xml_no_dtd'),
    '#name' => 'output',
  );
  $form['fieldset']['hidden-proxystylesheet'] = array (
    '#type' => 'hidden',
    '#value' => t('default_frontend'),
    '#name' => 'proxystylesheet',
    '#suffix' => '</div>'
  );
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter.
 */
function uiowa_bar_preprocess_uiowa_bar(&$variables) {
  $variables['uiowa_bar'] = build_uiowa_bar();
}

